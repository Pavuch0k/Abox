name: Deploy Docs to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Generate documentation from Markdown
        run: |
          mkdir -p _site
          
          # Устанавливаем marked
          npm install marked
          
          # Создаем скрипт преобразования
          cat > convert.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { marked } = require('marked');
          
          marked.setOptions({ gfm: true, breaks: true });
          
          // HTML шаблон
          function createPage(title, content, currentPage) {
            const pages = [
              { id: 'specification', title: 'Техническая спецификация' },
              { id: 'architecture', title: 'Архитектура' },
              { id: 'api', title: 'Документация API' },
              { id: 'deployment', title: 'Руководство по развертыванию' },
              { id: 'development', title: 'Руководство по разработке' }
            ];
            
            const nav = pages.map(p => 
              '<li><a href="' + p.id + '.html"' + 
              (p.id === currentPage ? ' class="active"' : '') + 
              '>' + p.title + '</a></li>'
            ).join('');
            
            return `<!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>${title} - ABox Docs</title>
              <style>
                  * { box-sizing: border-box; }
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
                      margin: 0; 
                      padding: 0; 
                      background: #0d1117; 
                      color: #c9d1d9;
                      line-height: 1.5;
                  }
                  .container { 
                      max-width: 1280px; 
                      margin: 0 auto; 
                      display: flex; 
                      min-height: 100vh;
                      padding: 24px;
                      gap: 24px;
                  }
                  .sidebar { 
                      width: 280px; 
                      background: #161b22; 
                      padding: 24px; 
                      border-radius: 6px; 
                      border: 1px solid #30363d;
                      height: fit-content;
                      position: sticky;
                      top: 24px;
                  }
                  .sidebar h2 { 
                      margin-top: 0; 
                      margin-bottom: 16px;
                      font-size: 20px;
                      font-weight: 600;
                      color: #f0f6fc;
                  }
                  .sidebar ul { 
                      list-style: none; 
                      padding: 0; 
                      margin: 0;
                  }
                  .sidebar li { 
                      margin-bottom: 4px; 
                  }
                  .sidebar a { 
                      color: #c9d1d9; 
                      text-decoration: none; 
                      padding: 8px 12px; 
                      display: block; 
                      border-radius: 6px; 
                      font-size: 14px;
                      transition: background-color 0.2s, color 0.2s;
                  }
                  .sidebar a:hover { 
                      background: #21262d; 
                      color: #f0f6fc;
                  }
                  .sidebar .active a { 
                      background: #1f6feb; 
                      color: #ffffff;
                      font-weight: 500;
                  }
                  .content { 
                      flex: 1; 
                      background: #0d1117; 
                      padding: 32px; 
                      border-radius: 6px;
                      border: 1px solid #30363d;
                      min-width: 0;
                  }
                  .markdown-body {
                      color: #c9d1d9;
                      font-size: 16px;
                  }
                  .markdown-body h1,
                  .markdown-body h2,
                  .markdown-body h3,
                  .markdown-body h4,
                  .markdown-body h5,
                  .markdown-body h6 {
                      color: #f0f6fc;
                      font-weight: 600;
                      margin-top: 24px;
                      margin-bottom: 16px;
                      line-height: 1.25;
                  }
                  .markdown-body h1 {
                      font-size: 32px;
                      padding-bottom: 8px;
                      border-bottom: 1px solid #30363d;
                  }
                  .markdown-body h2 {
                      font-size: 24px;
                      padding-bottom: 8px;
                      border-bottom: 1px solid #30363d;
                      margin-top: 32px;
                  }
                  .markdown-body h3 {
                      font-size: 20px;
                  }
                  .markdown-body p {
                      margin-bottom: 16px;
                  }
                  .markdown-body a {
                      color: #58a6ff;
                      text-decoration: none;
                  }
                  .markdown-body a:hover {
                      text-decoration: underline;
                  }
                  .markdown-body code {
                      background: #161b22;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-size: 85%;
                      color: #f85149;
                      border: 1px solid #30363d;
                  }
                  .markdown-body pre {
                      background: #161b22;
                      padding: 16px;
                      border-radius: 6px;
                      overflow-x: auto;
                      border: 1px solid #30363d;
                  }
                  .markdown-body pre code {
                      background: transparent;
                      padding: 0;
                      border: none;
                      color: #c9d1d9;
                      font-size: 85%;
                  }
                  .markdown-body blockquote {
                      padding: 0 16px;
                      color: #8b949e;
                      border-left: 4px solid #30363d;
                      margin: 0;
                  }
                  .markdown-body table {
                      border-collapse: collapse;
                      width: 100%;
                      margin: 16px 0;
                  }
                  .markdown-body table th,
                  .markdown-body table td {
                      padding: 8px 16px;
                      border: 1px solid #30363d;
                  }
                  .markdown-body table th {
                      background: #161b22;
                      font-weight: 600;
                      color: #f0f6fc;
                  }
                  .markdown-body table tr:nth-child(2n) {
                      background: #161b22;
                  }
                  .markdown-body ul,
                  .markdown-body ol {
                      padding-left: 24px;
                      margin-bottom: 16px;
                  }
                  .markdown-body li {
                      margin-bottom: 4px;
                  }
                  .markdown-body hr {
                      height: 1px;
                      background: #30363d;
                      border: none;
                      margin: 24px 0;
                  }
                  footer { 
                      margin-top: 48px; 
                      padding-top: 24px; 
                      border-top: 1px solid #30363d; 
                      color: #8b949e; 
                      text-align: center;
                      font-size: 14px;
                  }
                  @media (max-width: 768px) {
                      .container {
                          flex-direction: column;
                          padding: 16px;
                      }
                      .sidebar {
                          width: 100%;
                          position: static;
                      }
                      .content {
                          padding: 24px;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <nav class="sidebar">
                      <h2>Документация ABox</h2>
                      <ul>
                          <li ${currentPage === 'home' ? 'class="active"' : ''}>
                              <a href="index.html">Главная</a>
                          </li>
                          ${nav}
                      </ul>
                  </nav>
                  <main class="content markdown-body">
                      ${content}
                      <footer>
                          <p>Generated on ${new Date().toLocaleDateString()}</p>
                      </footer>
                  </main>
              </div>
          </body>
          </html>`;
          }
          
          // Главная страница
          const homeContent = marked.parse('# Добро пожаловать в документацию ABox\n\n' +
            'ABox — это модульная платформа для быстрого развертывания систем аутентификации.\n\n' +
            '## Доступная документация\n\n' +
            '- [Техническая спецификация](specification.html) - Требования проекта\n' +
            '- [Архитектура](architecture.html) - Дизайн системы\n' +
            '- [Документация API](api.html) - API эндпоинты\n' +
            '- [Руководство по развертыванию](deployment.html) - Как развернуть\n' +
            '- [Руководство по разработке](development.html) - Участие в разработке\n\n' +
            '## Статус проекта\n\n' +
            '**Статус**: В разработке  \n' +
            '**Версия**: 0.1.0  \n' +
            '**Последнее обновление**: ' + new Date().toLocaleDateString('ru-RU'));
          
          fs.writeFileSync('_site/index.html', createPage('Главная', homeContent, 'home'));
          console.log('Generated index.html');
          
          // Обрабатываем Markdown файлы
          const files = [
            { md: 'SPECIFICATION.md', html: 'specification.html', id: 'specification' },
            { md: 'ARCHITECTURE.md', html: 'architecture.html', id: 'architecture' },
            { md: 'API.md', html: 'api.html', id: 'api' },
            { md: 'DEPLOYMENT.md', html: 'deployment.html', id: 'deployment' },
            { md: 'DEVELOPMENT.md', html: 'development.html', id: 'development' }
          ];
          
          files.forEach(file => {
            const mdPath = path.join('docs', file.md);
            let content = '# ' + file.id.charAt(0).toUpperCase() + file.id.slice(1) + '\n\nDocument is being prepared.';
            
            if (fs.existsSync(mdPath)) {
              try {
                const md = fs.readFileSync(mdPath, 'utf8');
                if (md.trim()) {
                  content = marked.parse(md);
                  console.log('Processed: ' + file.md + ' (' + md.length + ' chars)');
                } else {
                  console.log('File is empty: ' + file.md);
                }
              } catch (e) {
                content = marked.parse('# Error\n\n' + e.message);
              }
            } else {
              console.log('File not found: ' + file.md);
            }
            
            const title = file.id.charAt(0).toUpperCase() + file.id.slice(1) + ' - ABox';
            fs.writeFileSync(path.join('_site', file.html), createPage(title, content, file.id));
            console.log('Generated: ' + file.html);
          });
          
          // Создаем .nojekyll
          fs.writeFileSync('_site/.nojekyll', '');
          EOF
          
          # Запускаем конвертацию
          node convert.js
          
          # Проверяем результат
          echo "=== Generated files ==="
          ls -la _site/*.html
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site/'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4