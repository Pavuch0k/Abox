name: Deploy Docs to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Generate documentation from Markdown
        run: |
          mkdir -p _site
          
          # Устанавливаем marked
          npm install marked
          
          # Создаем скрипт преобразования
          cat > convert.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { marked } = require('marked');
          
          marked.setOptions({ gfm: true, breaks: true });
          
          // HTML шаблон
          function createPage(title, content, currentPage) {
            const pages = [
              { id: 'specification', title: 'Technical Specification' },
              { id: 'architecture', title: 'Architecture' },
              { id: 'api', title: 'API Documentation' },
              { id: 'deployment', title: 'Deployment Guide' },
              { id: 'development', title: 'Development Guide' }
            ];
            
            const nav = pages.map(p => 
              '<li><a href="' + p.id + '.html"' + 
              (p.id === currentPage ? ' class="active"' : '') + 
              '>' + p.title + '</a></li>'
            ).join('');
            
            return `<!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>${title} - ABox Docs</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
              <style>
                  body { font-family: sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
                  .container { max-width: 1200px; margin: 0 auto; display: flex; }
                  .sidebar { width: 250px; background: white; padding: 20px; border-radius: 8px; margin-right: 20px; }
                  .content { flex: 1; background: white; padding: 30px; border-radius: 8px; }
                  .sidebar h2 { margin-top: 0; }
                  .sidebar ul { list-style: none; padding: 0; }
                  .sidebar li { margin-bottom: 10px; }
                  .sidebar a { color: #0366d6; text-decoration: none; padding: 8px 12px; display: block; border-radius: 4px; }
                  .sidebar a:hover { background: #f6f8fa; }
                  .sidebar .active a { background: #0366d6; color: white; }
                  footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e4e8; color: #6a737d; text-align: center; }
              </style>
          </head>
          <body>
              <div class="container">
                  <nav class="sidebar">
                      <h2>ABox Documentation</h2>
                      <ul>
                          <li ${currentPage === 'home' ? 'class="active"' : ''}>
                              <a href="index.html">Home</a>
                          </li>
                          ${nav}
                      </ul>
                  </nav>
                  <main class="content markdown-body">
                      ${content}
                      <footer>
                          <p>Generated on ${new Date().toLocaleDateString()}</p>
                      </footer>
                  </main>
              </div>
          </body>
          </html>`;
          }
          
          // Главная страница
          const homeContent = marked.parse('# Welcome to ABox Documentation\n\n' +
            'ABox is a modular platform for rapid deployment of authentication systems.\n\n' +
            '## Available Documentation\n\n' +
            '- [Technical Specification](specification.html) - Project requirements\n' +
            '- [Architecture](architecture.html) - System design\n' +
            '- [API Documentation](api.html) - API endpoints\n' +
            '- [Deployment Guide](deployment.html) - How to deploy\n' +
            '- [Development Guide](development.html) - Contributing\n\n' +
            '## Project Status\n\n' +
            '**Status**: In Development  \n' +
            '**Version**: 0.1.0  \n' +
            '**Last Updated**: ' + new Date().toLocaleDateString());
          
          fs.writeFileSync('_site/index.html', createPage('Home', homeContent, 'home'));
          console.log('Generated index.html');
          
          // Обрабатываем Markdown файлы
          const files = [
            { md: 'SPECIFICATION.md', html: 'specification.html', id: 'specification' },
            { md: 'ARCHITECTURE.md', html: 'architecture.html', id: 'architecture' },
            { md: 'API.md', html: 'api.html', id: 'api' },
            { md: 'DEPLOYMENT.md', html: 'deployment.html', id: 'deployment' },
            { md: 'DEVELOPMENT.md', html: 'development.html', id: 'development' }
          ];
          
          files.forEach(file => {
            const mdPath = path.join('docs', file.md);
            let content = '# ' + file.id.charAt(0).toUpperCase() + file.id.slice(1) + '\n\nDocument is being prepared.';
            
            if (fs.existsSync(mdPath)) {
              try {
                const md = fs.readFileSync(mdPath, 'utf8');
                if (md.trim()) {
                  content = marked.parse(md);
                  console.log('Processed: ' + file.md + ' (' + md.length + ' chars)');
                } else {
                  console.log('File is empty: ' + file.md);
                }
              } catch (e) {
                content = marked.parse('# Error\n\n' + e.message);
              }
            } else {
              console.log('File not found: ' + file.md);
            }
            
            const title = file.id.charAt(0).toUpperCase() + file.id.slice(1) + ' - ABox';
            fs.writeFileSync(path.join('_site', file.html), createPage(title, content, file.id));
            console.log('Generated: ' + file.html);
          });
          
          // Создаем .nojekyll
          fs.writeFileSync('_site/.nojekyll', '');
          EOF
          
          # Запускаем конвертацию
          node convert.js
          
          # Проверяем результат
          echo "=== Generated files ==="
          ls -la _site/*.html
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site/'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4