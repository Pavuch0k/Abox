name: Deploy Docs to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js for Markdown processing
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create HTML site from Markdown
        run: |
          mkdir -p _site
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º marked –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Markdown –≤ HTML
          npm install marked
          
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
          cat > convert.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { marked } = require('marked');
          
          // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è marked
          marked.setOptions({
            gfm: true,
            breaks: true,
            mangle: false,
            headerIds: false
          });
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è Markdown —Ñ–∞–π–ª–∞
          function readMarkdownFile(filename) {
            const filepath = path.join('docs', filename);
            try {
              if (fs.existsSync(filepath)) {
                const content = fs.readFileSync(filepath, 'utf8');
                return content || '# Document is empty\n\nAdd content to this document.';
              }
              return '# Document not found\n\nFile: ' + filename;
            } catch (error) {
              return '# Error reading document\n\n' + error.message;
            }
          }
          
          // HTML —à–∞–±–ª–æ–Ω
          function createHTML(title, content, pageId) {
            const pages = [
              { id: 'specification', title: 'Technical Specification' },
              { id: 'architecture', title: 'Architecture' },
              { id: 'api', title: 'API Documentation' },
              { id: 'deployment', title: 'Deployment Guide' },
              { id: 'development', title: 'Development Guide' }
            ];
            
            const navItems = pages.map(p => 
              `<li><a href="${p.id}.html" ${p.id === pageId ? 'class="active"' : ''}>${p.title}</a></li>`
            ).join('');
            
            return `<!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>${title} - ABox Documentation</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
                      max-width: 1200px; 
                      margin: 0 auto; 
                      padding: 20px; 
                      background: #f6f8fa;
                  }
                  .container {
                      display: flex;
                      gap: 30px;
                  }
                  .sidebar {
                      width: 250px;
                      flex-shrink: 0;
                      background: white;
                      padding: 25px;
                      border-radius: 12px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }
                  .content {
                      flex: 1;
                      background: white;
                      padding: 40px;
                      border-radius: 12px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                  }
                  .sidebar h1 {
                      color: #0366d6;
                      margin-top: 0;
                      font-size: 1.8rem;
                  }
                  .sidebar h2 {
                      color: #24292e;
                      font-size: 1.2rem;
                      margin-top: 30px;
                  }
                  .sidebar ul {
                      list-style: none;
                      padding: 0;
                      margin: 15px 0;
                  }
                  .sidebar li {
                      margin: 8px 0;
                  }
                  .sidebar a {
                      display: block;
                      padding: 10px 15px;
                      color: #24292e;
                      text-decoration: none;
                      border-radius: 6px;
                      transition: all 0.2s;
                  }
                  .sidebar a:hover {
                      background: #f6f8fa;
                      color: #0366d6;
                  }
                  .sidebar a.active {
                      background: #0366d6;
                      color: white;
                  }
                  .markdown-body {
                      background: transparent;
                      padding: 0;
                  }
                  footer {
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #e1e4e8;
                      color: #6a737d;
                      text-align: center;
                      font-size: 0.9rem;
                  }
                  .mermaid {
                      text-align: center;
                      margin: 20px 0;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <nav class="sidebar">
                      <h1>ABox Docs</h1>
                      <h2>Navigation</h2>
                      <ul>
                          <li><a href="index.html" ${pageId === 'home' ? 'class="active"' : ''}>Home</a></li>
                          ${navItems}
                      </ul>
                      <h2>Links</h2>
                      <ul>
                          <li><a href="https://github.com/Pavuch0k/Abox" target="_blank">GitHub Repository</a></li>
                          <li><a href="https://github.com/Pavuch0k/Abox/issues" target="_blank">Report Issues</a></li>
                      </ul>
                  </nav>
                  <main class="content">
                      <div class="markdown-body">
                          ${content}
                      </div>
                      <footer>
                          <p>Generated on ${new Date().toLocaleDateString()} | ABox Documentation</p>
                      </footer>
                  </main>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
              <script>
                  mermaid.initialize({ startOnLoad: true, theme: 'default' });
              </script>
          </body>
          </html>`;
          }
          
          // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
          const homeContent = marked.parse(`
# Welcome to ABox Documentation

ABox is a modular, microservice-based platform for rapid deployment of authentication and registration systems.

## üìö Available Documentation

- [Technical Specification](specification.html) - Project requirements and goals
- [Architecture](architecture.html) - System design and components  
- [API Documentation](api.html) - API endpoints and usage
- [Deployment Guide](deployment.html) - How to deploy ABox
- [Development Guide](development.html) - Guide for contributors

## üöÄ Quick Start

1. Check the [Technical Specification](specification.html) for project overview
2. Read the [Architecture](architecture.html) to understand the system design
3. Follow the [Deployment Guide](deployment.html) to set up ABox

## üìä Project Status

**Status**: In Development  
**Version**: 0.1.0  
**Last Updated**: ${new Date().toLocaleDateString()}

---

*This documentation is generated from Markdown files in the \`docs/\` folder.*
          `);
          
          fs.writeFileSync('_site/index.html', createHTML('Home', homeContent, 'home'));
          console.log('Generated: index.html');
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π Markdown —Ñ–∞–π–ª
          const files = [
            { md: 'SPECIFICATION.md', html: 'specification.html', id: 'specification', title: 'Technical Specification' },
            { md: 'ARCHITECTURE.md', html: 'architecture.html', id: 'architecture', title: 'Architecture' },
            { md: 'API.md', html: 'api.html', id: 'api', title: 'API Documentation' },
            { md: 'DEPLOYMENT.md', html: 'deployment.html', id: 'deployment', title: 'Deployment Guide' },
            { md: 'DEVELOPMENT.md', html: 'development.html', id: 'development', title: 'Development Guide' }
          ];
          
          files.forEach(file => {
            const markdownContent = readMarkdownFile(file.md);
            const htmlContent = marked.parse(markdownContent);
            fs.writeFileSync(path.join('_site', file.html), createHTML(file.title, htmlContent, file.id));
            console.log('Generated: ' + file.html + ' from ' + file.md);
            
            // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('--- Content preview for ' + file.md + ' ---');
            console.log(markdownContent.substring(0, 200) + '...');
            console.log('--- End preview ---\n');
          });
          
          // –°–æ–∑–¥–∞–µ–º .nojekyll —Ñ–∞–π–ª
          fs.writeFileSync('_site/.nojekyll', '');
          console.log('Created .nojekyll file');
          
          // –õ–æ–≥–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
          console.log('\n=== Final files in _site/ ===');
          const siteFiles = fs.readdirSync('_site');
          siteFiles.forEach(f => {
            const stats = fs.statSync(path.join('_site', f));
            console.log(f + ' (' + stats.size + ' bytes)');
          });
          EOF
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
          node convert.js
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          echo "=== Checking generated HTML files ==="
          ls -la _site/*.html
          echo ""
          echo "=== First few lines of specification.html ==="
          head -20 _site/specification.html
          
      - name: Debug - Show what was generated
        run: |
          echo "=== Files in _site/ ==="
          find _site -type f -name "*.html" | xargs wc -l
          echo ""
          echo "=== Checking if Markdown content is included ==="
          grep -n "Technical Specification" _site/specification.html || echo "Content not found in specification.html"
          grep -n "Architecture" _site/architecture.html || echo "Content not found in architecture.html"
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site/'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
