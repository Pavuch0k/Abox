name: Deploy Docs to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create basic structure
        run: |
          mkdir -p _site
          echo "Creating basic HTML structure..."
          
      - name: Generate HTML from Markdown
        run: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º marked –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Markdown –≤ HTML
          npm install marked
          
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const { marked } = require('marked');
          
          // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è marked
          marked.setOptions({
            gfm: true,
            breaks: true
          });
          
          // –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
          const documents = [
            { 
              id: 'specification',
              file: 'SPECIFICATION.md',
              title: 'Technical Specification',
              description: 'Project requirements and goals'
            },
            { 
              id: 'architecture', 
              file: 'ARCHITECTURE.md',
              title: 'Architecture',
              description: 'System design and components'
            },
            { 
              id: 'api',
              file: 'API.md',
              title: 'API Documentation',
              description: 'API endpoints and usage'
            },
            { 
              id: 'deployment',
              file: 'DEPLOYMENT.md',
              title: 'Deployment Guide',
              description: 'How to deploy ABox'
            },
            { 
              id: 'development',
              file: 'DEVELOPMENT.md',
              title: 'Development Guide',
              description: 'Guide for contributors'
            }
          ];
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è Markdown —Ñ–∞–π–ª–∞
          function readMarkdown(filePath) {
            try {
              if (fs.existsSync(filePath)) {
                return fs.readFileSync(filePath, 'utf8');
              }
              return '# Document Not Found\n\nThis document is being prepared. Please check back later.';
            } catch (error) {
              return '# Error\n\nUnable to read document: ' + error.message;
            }
          }
          
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —à–∞–±–ª–æ–Ω
          function generateHTML(title, content, activeId) {
            const navItems = documents.map(doc => {
              const isActive = doc.id === activeId ? 'active' : '';
              return `
                <li class="nav-item ${isActive}">
                  <a href="${doc.id}.html" class="nav-link">
                    <span class="nav-title">${doc.title}</span>
                    <span class="nav-desc">${doc.description}</span>
                  </a>
                </li>`;
            }).join('');
            
            return `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${title} - ABox Documentation</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        line-height: 1.6;
                        color: #24292e;
                        background: #f6f8fa;
                    }
                    
                    .container {
                        display: flex;
                        min-height: 100vh;
                    }
                    
                    .sidebar {
                        width: 300px;
                        background: #fff;
                        border-right: 1px solid #e1e4e8;
                        padding: 2rem;
                        position: fixed;
                        height: 100vh;
                        overflow-y: auto;
                    }
                    
                    .logo {
                        margin-bottom: 2rem;
                        padding-bottom: 1rem;
                        border-bottom: 1px solid #e1e4e8;
                    }
                    
                    .logo h1 {
                        font-size: 1.5rem;
                        color: #0366d6;
                        margin-bottom: 0.25rem;
                    }
                    
                    .logo p {
                        color: #6a737d;
                        font-size: 0.9rem;
                    }
                    
                    .nav-list {
                        list-style: none;
                    }
                    
                    .nav-item {
                        margin-bottom: 0.5rem;
                    }
                    
                    .nav-link {
                        display: block;
                        padding: 0.75rem 1rem;
                        text-decoration: none;
                        border-radius: 6px;
                        transition: all 0.2s;
                        border: 1px solid transparent;
                    }
                    
                    .nav-link:hover {
                        background: #f6f8fa;
                        border-color: #e1e4e8;
                    }
                    
                    .nav-item.active .nav-link {
                        background: #0366d6;
                        color: white;
                        border-color: #0366d6;
                    }
                    
                    .nav-title {
                        display: block;
                        font-weight: 600;
                    }
                    
                    .nav-desc {
                        display: block;
                        font-size: 0.85rem;
                        opacity: 0.8;
                        margin-top: 0.25rem;
                    }
                    
                    .content {
                        flex: 1;
                        margin-left: 300px;
                        padding: 3rem;
                        max-width: 900px;
                    }
                    
                    .document {
                        background: white;
                        padding: 3rem;
                        border-radius: 12px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    }
                    
                    footer {
                        margin-top: 3rem;
                        padding-top: 2rem;
                        border-top: 1px solid #e1e4e8;
                        color: #6a737d;
                        font-size: 0.9rem;
                        text-align: center;
                    }
                    
                    @media (max-width: 768px) {
                        .container {
                            flex-direction: column;
                        }
                        
                        .sidebar {
                            width: 100%;
                            height: auto;
                            position: static;
                            border-right: none;
                            border-bottom: 1px solid #e1e4e8;
                        }
                        
                        .content {
                            margin-left: 0;
                            padding: 1.5rem;
                        }
                        
                        .document {
                            padding: 1.5rem;
                        }
                    }
                </style>
                <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
            </head>
            <body>
                <div class="container">
                    <aside class="sidebar">
                        <div class="logo">
                            <h1>ABox</h1>
                            <p>Auth-in-a-Box Platform</p>
                        </div>
                        <ul class="nav-list">
                            <li class="nav-item ${activeId === 'home' ? 'active' : ''}">
                                <a href="index.html" class="nav-link">
                                    <span class="nav-title">Home</span>
                                    <span class="nav-desc">Overview and quick start</span>
                                </a>
                            </li>
                            ${navItems}
                            <li class="nav-item">
                                <a href="https://github.com/Pavuch0k/Abox" class="nav-link" target="_blank">
                                    <span class="nav-title">GitHub Repository</span>
                                    <span class="nav-desc">View source code</span>
                                </a>
                            </li>
                        </ul>
                    </aside>
                    
                    <main class="content">
                        <div class="document markdown-body">
                            ${content}
                        </div>
                        <footer>
                            <p>ABox Documentation &copy; 2025</p>
                            <p>Generated on ${new Date().toLocaleDateString()}</p>
                        </footer>
                    </main>
                </div>
                
                <script>
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mermaid –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
                    mermaid.initialize({ 
                        startOnLoad: true,
                        theme: 'default'
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
                    document.addEventListener('DOMContentLoaded', function() {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Å—ã–ª–∫–∏ .md –≤ .html
                        document.querySelectorAll('a[href$=".md"]').forEach(link => {
                            link.href = link.href.replace('.md', '.html');
                        });
                        
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º Mermaid –¥–∏–∞–≥—Ä–∞–º–º—ã
                        mermaid.init();
                    });
                </script>
            </body>
            </html>`;
          }
          
          // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
          const homeContent = marked.parse(`
# Welcome to ABox Documentation

ABox is a modular, microservice-based platform for rapid deployment of authentication and registration systems.

## üìñ Documentation Sections

1. **Technical Specification** - Project goals, requirements, and scope
2. **Architecture** - System design, components, and technologies
3. **API Documentation** - Endpoints, requests, and responses
4. **Deployment Guide** - How to deploy ABox in various environments
5. **Development Guide** - Contributing to the project

## üöÄ Quick Start

For a quick overview, start with the [Technical Specification](specification.html).

## üîó Useful Links

- [GitHub Repository](https://github.com/Pavuch0k/Abox)
- [Issue Tracker](https://github.com/Pavuch0k/Abox/issues)

## üìä Project Status

| Status | Version | Last Updated |
|--------|---------|--------------|
| In Development | 0.1.0 | ${new Date().toLocaleDateString()} |

---

*This documentation is automatically generated from Markdown files.*
          `);
          
          fs.writeFileSync('_site/index.html', generateHTML('Home', homeContent, 'home'));
          console.log('Generated: index.html');
          
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
          documents.forEach(doc => {
            const mdPath = path.join('docs', doc.file);
            const mdContent = readMarkdown(mdPath);
            const htmlContent = marked.parse(mdContent);
            
            fs.writeFileSync(
              path.join('_site', `${doc.id}.html`),
              generateHTML(doc.title, htmlContent, doc.id)
            );
            
            console.log(\`Generated: \${doc.id}.html\`);
          });
          
          // –°–æ–∑–¥–∞–µ–º .nojekyll —Ñ–∞–π–ª
          fs.writeFileSync('_site/.nojekyll', '');
          console.log('Created .nojekyll file');
          
          // –ö–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ docs
          if (fs.existsSync('docs')) {
            const files = fs.readdirSync('docs');
            files.forEach(file => {
              if (file !== '.nojekyll' && !file.endsWith('.md')) {
                const src = path.join('docs', file);
                const dest = path.join('_site', file);
                fs.copyFileSync(src, dest);
                console.log(\`Copied: \${file}\`);
              }
            });
          }
          EOF
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
          node generate.js
          
      - name: Verify generated files
        run: |
          echo "=== Generated files in _site/ ==="
          ls -la _site/
          echo ""
          echo "=== File list ==="
          find _site -type f -name "*.html" | sort
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site/'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
