# ABox — Technical Specification

## Авторы  
- [Pavuch0k](https://github.com/Pavuch0k) (начальный автор, архитектор)  
- [m1keeeD](https://github.com/m1keeeD) (Java-разработчик)  

## Дата создания / версия  
- Версия: 0.1-draft  
- Дата: 2025-12-XX  

---

## 1. Назначение и цель проекта  

**ABox** — это модульная, микросервисная платформа для быстрой развёртки системы авторизации, регистрации и управления пользователями.  
Цель — дать разработчикам простой, готовый к использованию “auth-блок”, включающий UI для логина/регистрации, REST API для приложений, хранение пользователей, токены, сессии, метрики и возможность горизонтального масштабирования.  

---

## 2. Область применения и границы  

### Входит (scope):  
- Регистрация пользователей (email + пароль)  
- Вход / логин  
- Выдача JWT (access + refresh)  
- Обновление (refresh) токенов  
- Хранение пользователей (база данных)  
- Хранение сессий / refresh токенов (Redis / кэш)  
- REST API для внешних приложений: проверка токена, получение данных пользователя  
- UI-модуль: страницы регистрации, логина, сброса пароля (минимальный)  
- Метрики и мониторинг (Prometheus + Grafana)  
- Документация API  

### Не входит (на старте):  
- Роли / сложная RBAC / ACL  
- OAuth2 / внешние провайдеры (Google, соцсети) — опционально в будущем  
- Админ-панель (расширенная) / управление пользователями через UI  
- MFA / 2FA (двухфакторная аутентификация)  
- Расширенная система уведомлений (SMS, push) — минимум email (по необходимости)  
- Бизнес-логику приложений, использующих ABox — только auth/identity  

---

## 3. Общая архитектура  

- Микросервисная структура, каждый сервис — отдельный контейнер.  
- Контейнеризация: Docker + (в перспективе) Kubernetes + Helm.  
- Сервисы: gateway, auth-service, user-service, session-service, ui-service, metrics-service (и при необходимости notification-service).  
- База данных: PostgreSQL для пользователей и данных persist.  
- Redis — для сессий / хранения refresh-токенов / кэша.  
- Метрики: Prometheus, с визуализацией в Grafana.  
- API — REST + JWT + HTTPs; UI — лёгкий frontend (может быть React, Thymeleaf или простой HTML/CSS)  

---

## 4. Функциональные требования  

### 4.1 Регистрация  
- Пользователь вводит email + пароль  
- Проверка валидности email, проверка, что email ещё не зарегистрирован  
- Пароль хэшируется (bcrypt / argon2) перед сохранением  
- Запись нового пользователя в базу  

### 4.2 Авторизация / логин  
- Пользователь вводит email + пароль  
- Проверка пароля → при успехе:  
  - создание access_token (JWT, с коротким сроком)  
  - создание refresh_token (JWT или opaque-токен), сохранение в session-service / Redis  
- Возврат токенов клиенту  

### 4.3 Обновление токенов (refresh)  
- Клиент отправляет refresh_token  
- Проверка валидности + существования в session-service  
- Генерация нового access_token (+ по желанию refresh_token)  
- Возврат новых токенов  

### 4.4 API для внешних приложений  
- Эндпоинт проверки токена (validate) → возвращает “валиден/невалиден + данные пользователя”  
- Эндпоинт получения информации о пользователе (`/user/me`) при передаче access_token  
- Возможность других сервисов использовать ABox как централизованный auth  

### 4.5 UI-модуль  
- Страница регистрации `/register`  
- Страница логина `/login`  
- Страница восстановления/сброса пароля `/forgot-password`, `/reset-password` (минимум placeholder)  
- Лёгкая форма, базовая вёрстка, возможность кастомизации  

### 4.6 Метрики и мониторинг  
- Счётчики: регистраций/минуту, логинов/минуту, неудачных логинов, число активных сессий, обновлений токенов, ошибок  
- Latency / время ответа  
- Экспорт метрик через Prometheus endpoint  
- Базовый график в Grafana  

---

## 5. Нефункциональные требования  

- Безопасность: хранение хэшей паролей, HTTPS, защита сессий, защита от brute-force (rate limiting)  
- Масштабируемость: все сервисы независимые, легко масштабируются. Горизонтальное масштабирование через Kubernetes + HPA  
- Производительность: Redis + PostgreSQL → быстрый отклик, токены / сессии — кеширование  
- Надёжность: при недоступности одного сервиса — остальные продолжают работать корректно; устойчивое подключение к БД и Redis; graceful shutdown контейнеров  
- Лёгкость настройки и развёртывания: Docker-compose / Helm + конфигурация через env / config-файлы  

---

## 6. API-эндпоинты (черновой список)  

POST   /auth/register        # Регистрация пользователя
POST   /auth/login           # Логин, выдача access/refresh токенов
POST   /auth/refresh         # Обновление токенов
GET    /auth/validate        # Проверка access_token + получение данных пользователя

GET    /user/me              # Получить профиль пользователя (по access_token)
PUT    /user/email           # Изменить email
PUT    /user/password        # Изменить пароль

# По желанию (reset password flow)
GET    /auth/forgot-password # Страница запроса сброса пароля
POST   /auth/forgot-password # Запрос ссылки/кода для сброса
POST   /auth/reset-password  # Сброс пароля по токену




Дополнительно — эндпоинты админ / управление сессиями / администрирование (на потом).  

---

## 7. Этапы (MVP + дорожная карта)  

| Этап | Что включено |
|------|--------------|
| MVP  | Регистрация + логин + JWT + refresh + user-service + базовое UI + Docker-compose + документация API |
| 1    | UI-модуль, сброс пароля, базовая вёрстка, README, примеры запуска |
| 2    | Метрики + мониторинг, Helm-charts, Kubernetes, горизонтальное масштабирование |
| 3    | (Опционально) Notification-service, email-подтверждение, расширенное управление пользователями, админ-интерфейс, RBAC/роли |
| 4    | Расширения: OAuth2, внешние Identity-провайдеры, 2FA, интеграции, плагины |

---

## 8. Ограничения и допущения  

- Проект рассчитан на веб/REST-приложения; специфичных мобильных SDK на старте нет  
- В UI используется минимализм; дизайн — базовый, без претензий на “красивый frontend”  
- В качестве отправки email / уведомлений — простой SMTP / placeholder — без сложной инфраструктуры  
- RBAC/роли, OAuth, 2FA — не в MVP, реализация возможна, но позже  

---

## 9. Мониторинг и метрики  

- Prometheus endpoint: `/metrics`  
- Метрики:  
  - total_requests, requests_per_second (логин, регистрация, refresh)  
  - auth_failures, login_failures  
  - active_sessions, expired_sessions  
  - latency в отвечании сервисов  
- Дашборд в Grafana (базовый — latency + количество логинов/регистраций + сессий)  

---

## 10. Развёртывание  

- **Локально:** Docker Compose (PostgreSQL + Redis + сервисы)  
- **В продакшен:** Kubernetes + Helm charts + конфигурация через env / секреты  
- Документировать переменные среды, конфиги, зависимости  

---

## 11. Документация  

- README.md — краткое описание, “быстрый старт”  
- specification.md — этот документ  
- API документация (OpenAPI / swagger) — позже  
- Руководство по развёртыванию (deployment guide)  
- Руководство по кастомизации UI  

---

## 12. Планы развития  

- Версия 0.1 → MVP  
- Привлечение контрибьюторов: описать CONTRIBUTING.md  
- Написание тестов, CI/CD, quality checks  
- Расширение функционала: роли, OAuth, 2FA, admin UI  

